                                          **************************
                                          *****   Dockerfile   *****
                                          **************************


========================================================================================================================
FROM amazoncorretto:25 AS builder
========================================================================================================================
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ Amazon Corretto JDK 25 –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π builder-–æ–±—Ä–∞–∑ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å–ª–æ—ë–≤ Spring Boot-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.


========================================================================================================================
WORKDIR /project
========================================================================================================================
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî —Å—é–¥–∞ –±—É–¥–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω JAR.


========================================================================================================================
COPY individuals-api/build/libs/individuals-api.jar /project/app.jar
========================================================================================================================
–ö–æ–ø–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤—ã–π executable JAR, —Å–æ–±—Ä–∞–Ω–Ω—ã–π –≤–Ω–µ Docker (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ ./gradlew :individuals-api:bootJar), –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–¥ –∏–º–µ–Ω–µ–º app.jar.

/project/
‚îî‚îÄ‚îÄ app/                     ‚Üê –∏–º—è –ø–∞–ø–∫–∏ = –∏–º—è JAR –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ dependencies/        ‚Üê –æ–±—ã—á–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (non-SNAPSHOT)
    ‚îú‚îÄ‚îÄ snapshot-dependencies/‚Üê SNAPSHOT-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    ‚îú‚îÄ‚îÄ application/         ‚Üê –≤–∞—à —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ (classes + resources)
    ‚îî‚îÄ‚îÄ spring-boot-loader/  ‚Üê –∑–∞–≥—Ä—É–∑—á–∏–∫ Spring Boot


========================================================================================================================
java -Djarmode=tools -jar app.jar extract --layers --launcher
========================================================================================================================
–ó–∞–ø—É—Å–∫–∞–µ—Ç JAR –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ (jarmode=tools), —á—Ç–æ–±—ã –∏–∑–≤–ª–µ—á—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:
--layers ‚Äî —Ä–∞–∑–¥–µ–ª—è–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞ —Å–ª–æ–∏ (dependencies/, snapshot-dependencies/, application/),
--launcher ‚Äî –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫ Spring Boot (org.springframework.boot.loader.launch.JarLauncher).

üí° –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–∞–ø–∫–∞ /project/app/ —Å –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∞–º–∏ dependencies/, application/ –∏ —Ç.–¥.


========================================================================================================================
rm -f app.jar
========================================================================================================================
–£–¥–∞–ª—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π JAR-—Ñ–∞–π–ª, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω.


========================================================================================================================
FROM amazoncorretto:25
========================================================================================================================
–ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—ã–π, —á–∏—Å—Ç—ã–π –æ–±—Ä–∞–∑ –Ω–∞ –±–∞–∑–µ —Ç–æ–≥–æ –∂–µ Corretto, –Ω–æ –±–µ–∑ Gradle, –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –∏ builder-–∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.


========================================================================================================================
yum install -y --allowerasing curl shadow-utils findutils
========================================================================================================================
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —É—Ç–∏–ª–∏—Ç—ã:
curl ‚Äî –¥–ª—è healthcheck –≤ docker-compose.yml,
shadow-utils ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç useradd, groupadd (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏),
findutils ‚Äî —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–º–∞–Ω–¥—É find (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–Ω—É–∂–Ω—ã—Ö JAR-—Ñ–∞–π–ª–æ–≤).
üí° --allowerasing –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å curl-minimal (–µ—Å–ª–∏ –æ–Ω –±—ã–ª) –Ω–∞ –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é curl.


========================================================================================================================
yum clean all
========================================================================================================================
–û—á–∏—â–∞–µ—Ç –∫—ç—à yum, —á—Ç–æ–±—ã —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞.


========================================================================================================================
groupadd -g 1001 pspuser && useradd -u 1001 -g pspuser -m -s /bin/false pspuser
========================================================================================================================
–°–æ–∑–¥–∞—ë—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è pspuser (UID/GID = 1001) –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —ç—Ç–æ best practice –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.


========================================================================================================================
WORKDIR /app
========================================================================================================================
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ /app.


========================================================================================================================
COPY --from=builder /project/app/dependencies/ ./
COPY --from=builder /project/app/spring-boot-loader/ ./
COPY --from=builder /project/app/snapshot-dependencies/ ./
COPY --from=builder /project/app/application/ ./
========================================================================================================================
–ö–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–ª–æ–∏ –∏–∑ builder-—Å—Ç–∞–¥–∏–∏:
1) dependencies/ ‚Äî –æ–±—ã—á–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏,
2) snapshot-dependencies/ ‚Äî SNAPSHOT-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å),
3) application/ ‚Äî –≤–∞—à —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥,
4) spring-boot-loader/ ‚Äî –∑–∞–≥—Ä—É–∑—á–∏–∫ Spring Boot.
üí° –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∏ –≤ Docker: –µ—Å–ª–∏ –≤—ã –ø–æ–º–µ–Ω—è–ª–∏ —Ç–æ–ª—å–∫–æ –∫–æ–¥ ‚Äî –ø–µ—Ä–µ—Å–æ–±–µ—Ä—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ application/.

–ü–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ /app –±—É–¥–µ—Ç –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç, –ø–æ–Ω—è—Ç–Ω—ã–π Spring Boot JarLauncher:
   /app/
   ‚îú‚îÄ‚îÄ BOOT-INF/
   ‚îÇ   ‚îú‚îÄ‚îÄ lib/        ‚Üê –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (dependencies + snapshot-dependencies + application/lib)
   ‚îÇ   ‚îî‚îÄ‚îÄ classes/    ‚Üê –≤–∞—à –∫–æ–¥ –∏ —Ä–µ—Å—É—Ä—Å—ã (–∏–∑ application/classes)
   ‚îú‚îÄ‚îÄ org/            ‚Üê Spring Boot loader (–∏–∑ spring-boot-loader/)
   ‚îî‚îÄ‚îÄ classpath.idx   ‚Üê –ø–æ—Ä—è–¥–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ classpath (—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)


========================================================================================================================
find BOOT-INF/lib/ -name "*-sources.jar" -delete
find BOOT-INF/lib/ -name "*-javadoc.jar" -delete
find BOOT-INF/lib/ -name "*-tests.jar" -delete
========================================================================================================================
‚Üí –£–¥–∞–ª—è–µ—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–Ω–æ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Å–±–æ—Ä–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∞—é—Ç sources/javadoc).
‚Üí –≠—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ –∏ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.


========================================================================================================================
chown -R pspuser:pspuser /app
========================================================================================================================
‚Üí –ù–∞–∑–Ω–∞—á–∞–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.


========================================================================================================================
USER pspuser
========================================================================================================================
‚Üí –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è pspuser ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –æ—Ç root.


========================================================================================================================
EXPOSE 8081
========================================================================================================================
‚Üí –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 8081 (–Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ, —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ).


========================================================================================================================
ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]
========================================================================================================================
‚Üí –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Spring Boot JarLauncher, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–ª–æ—ë–≤ (BOOT-INF/, classpath.idx –∏ —Ç.–¥.).


========================================================================================================================
USER pspuser
========================================================================================================================
–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è pspuser ‚Äî –≤—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ—Ç –µ–≥–æ –∏–º–µ–Ω–∏.


========================================================================================================================
EXPOSE 8081
========================================================================================================================
> **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç**, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç `8081`.
> –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ, Docker Compose —Å–∞–º –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç—ã, –Ω–æ —ç—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞.


========================================================================================================================
ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]
========================================================================================================================
–ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ JarLauncher ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ Spring Boot –¥–ª—è —Å–ª–æ–∏—Å—Ç—ã—Ö JAR'–æ–≤.
–û–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥—ë—Ç –∫–ª–∞—Å—Å—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.
